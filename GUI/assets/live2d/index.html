<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Live2D Preview</title>
    <!-- Live2D Cubism Core (v4) & Live2D v2 runtime -->
    <script src="../vender/live2dcubismcore.min.js"></script>
    <script src="../vender/live2d.min.js"></script>

    <!-- PixiJS v7 and expose to window for plugin -->
    <script src="../vender/pixi.min.js"></script>
    <script>
        window.PIXI = PIXI;
    </script>

    <!-- pixi-live2d-displayÔºàÂêåÊó∂ÊîØÊåÅ Cubism 2.1 ‰∏é 4Ôºâ -->
    <script src="../vender/index.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        #canvas {
            border: 2px solid #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.1);
            width: 90vw;
            height: 85vh;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        #ui-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        #toggle-info {
            appearance: none;
            border: none;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }
        #toggle-info:hover { background: rgba(0,0,0,0.75); }
        .info-section {
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .info-section:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: bold;
            color: #ffd93d;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Preparing Live2D Previewer...</div>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
            Loading rendering engine...
        </div>
    </div>
    
    <div id="error" style="display: none;">
        <h3>‚ùå Loading Failed</h3>
        <p id="error-message">Unknown error</p>
        <div style="font-size: 12px; margin-top: 15px; opacity: 0.8;">
            Please check network connection or refresh page to retry
        </div>
    </div>
    
    <div id="info" style="display: none;">
        <div class="info-section">
            <div class="info-label">üé≠ Live2D Web Previewer</div>
        </div>
        <div class="info-section">
            <div class="info-label">Model Info</div>
            <div id="model-info">No model loaded</div>
        </div>
        <div class="info-section">
            <div class="info-label">Expression</div>
            <div id="expression-info">None</div>
        </div>
        <div class="info-section">
            <div class="info-label">Motion</div>
            <div id="motion-info">None</div>
        </div>
    </div>
    <div id="ui-controls">
        <button id="toggle-info" title="Shortcut: H or Double-click canvas">Hide Panel [H]</button>
    </div>
    
    <canvas id="canvas" width="800" height="600" style="display: none;"></canvas>
    
    <script>
        // Live2D WebÈ¢ÑËßàÂô® - ‰ΩøÁî®PIXI.jsÂíåLive2D Cubism SDK
        class Live2DPreview {
            constructor() {
                this.app = null;
                this.model = null;
                this.modelData = null;
                this.currentExpression = null;
                this.currentMotion = null;
                this.canvasWidth = 800;  // ÂÆûÈôÖÁöÑCSSÂÉèÁ¥†ÂÆΩÂ∫¶
                this.canvasHeight = 600; // ÂÆûÈôÖÁöÑCSSÂÉèÁ¥†È´òÂ∫¶
                this.init();
            }
            
            async init() {
                try {
                    // Ê£ÄÊü•Live2D SDKÊòØÂê¶Âä†ËΩΩ
                    if (typeof PIXI === 'undefined') {
                        throw new Error('PIXI.js not loaded');
                    }
                    
                    // Ëé∑ÂèñcanvasÂÖÉÁ¥†Âπ∂ËÆ°ÁÆóÂàùÂßãÂ∞∫ÂØ∏
                    const canvas = document.getElementById('canvas');
                    // ‰øÆÂ§çÈ´ò DPI ÊòæÁ§∫Âô®‰∏äÁöÑÂ∞∫ÂØ∏ÈóÆÈ¢ò
                    // ‰ΩøÁî® clientWidth/Height ËÄå‰∏çÊòØÁõ¥Êé•‰ΩøÁî®Á™óÂè£Â∞∫ÂØ∏
                    let containerWidth = canvas.clientWidth || canvas.offsetWidth || 800;
                    let containerHeight = canvas.clientHeight || canvas.offsetHeight || 600;
                    
                    // Â¶ÇÊûú canvas ËøòÊ≤°ÊúâË¢´Ê∏≤ÊüìÔºå‰ΩøÁî®Á™óÂè£Â∞∫ÂØ∏‰Ωú‰∏∫ÂêéÂ§á
                    if (containerWidth === 0 || containerHeight === 0) {
                        containerWidth = window.innerWidth * 0.9;
                        containerHeight = window.innerHeight * 0.85;
                    }
                    
                    console.log(`Initial container size: ${containerWidth}x${containerHeight}, DPR: ${window.devicePixelRatio}`);
                    
                    // ÂàùÂßãÂåñPIXIÂ∫îÁî®Ôºå‰ΩøÁî®Âä®ÊÄÅÂ∞∫ÂØ∏
                    // Âú®È´ò DPI ÊòæÁ§∫Âô®‰∏äÔºå‰ΩøÁî®Âõ∫ÂÆö resolution=1 Êù•ÈÅøÂÖçÂÆö‰ΩçÈóÆÈ¢ò
                    this.app = new PIXI.Application({
                        view: canvas,
                        width: Math.max(400, Math.floor(containerWidth)),
                        height: Math.max(300, Math.floor(containerHeight)),
                        backgroundColor: 0x1099bb,
                        backgroundAlpha: 0.1,
                        resolution: window.devicePixelRatio || 1,
                        autoDensity: true 
                    });
                    
                    // ËÆæÁΩÆËàûÂè∞
                    this.setupStage();

                    // Ê†πÊçÆËßÜÂè£Â∞∫ÂØ∏Ëá™ÈÄÇÂ∫îÊ∏≤ÊüìÂô®Â§ßÂ∞è
                    this.updateCanvasSize();
                    
                    // Ê∑ªÂä†Á™óÂè£Â§ßÂ∞èÂèòÂåñÁõëÂê¨
                    window.addEventListener('resize', () => {
                        this.updateCanvasSize();
                        if (this.model) {
                            this.fitModelToView();
                        }
                    });
                    
                    // Ê∑ªÂä†ÂÆöÊó∂Âô®Á°Æ‰øùÂàùÂßãÊ∏≤ÊüìÊ≠£Á°Æ
                    setTimeout(() => {
                        this.updateCanvasSize();
                        if (this.model) {
                            this.fitModelToView();
                        }
                    }, 50);
                    
                    // ÁõëÂê¨Êù•Ëá™PythonÁöÑÊ∂àÊÅØ
                    window.addEventListener('message', (event) => {
                        this.handleMessage(event.data);
                    });
                    
                    // ÊòæÁ§∫ÁîªÂ∏ÉÂíå‰ø°ÊÅØÈù¢Êùø
                    document.getElementById('canvas').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('info').style.display = 'block';
                    this.infoVisible = true;
                    const toggleBtn = document.getElementById('toggle-info');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', () => this.toggleInfoPanel());
                    }
                    window.addEventListener('keydown', (e) => {
                        if (e.key === 'h' || e.key === 'H') this.toggleInfoPanel();
                    });
                    // ÂèåÂáªÁîªÂ∏ÉÂø´ÈÄüÂºÄÂÖ≥
                    this.app.view.addEventListener('dblclick', () => this.toggleInfoPanel());
                    
                    // ÈÄöÁü•PythonÈ¢ÑËßàÂô®Â∑≤ÂáÜÂ§áÂ∞±Áª™
                    this.sendMessage('ready', {});

                    // Â¶ÇÊûúÈÄöËøá URL ÂèÇÊï∞Êèê‰æõ‰∫ÜÊ®°Âûã‰ø°ÊÅØÔºåÂàôËá™Âä®Âä†ËΩΩ
                    try {
                        const params = new URLSearchParams(window.location.search);
                        const directUrl = params.get('modelUrl');
                        const base = params.get('modelBase');
                        const entry = params.get('modelJson');
                        let autoUrl = null;
                        if (directUrl) {
                            autoUrl = directUrl;
                        } else if (base && entry) {
                            autoUrl = base.replace(/\/$/, '') + '/' + entry.replace(/^\//, '');
                        }
                        if (autoUrl) {
                            console.log('Auto-loading model from URL params:', autoUrl);
                            await this.loadModel(autoUrl, null);
                        }
                    } catch (e) {
                        console.warn('Failed to parse URL params for auto model load:', e);
                    }

                    // ËøûÊé• WebSocket Êé•Êî∂Á®ãÂ∫èÂπøÊí≠ÁöÑÊéßÂà∂Ê∂àÊÅØÔºåÂÆûÁé∞‰∏éÂ∑¶‰æßÈù¢ÊùøÂêåÊ≠•
                    try {
                        const wsProto = (location.protocol === 'https:') ? 'wss' : 'ws';
                        const wsUrl = `${wsProto}://${location.host}/ws/preview`;
                        console.log('Connecting WebSocket:', wsUrl);
                        const ws = new WebSocket(wsUrl);
                        ws.onopen = () => console.log('WebSocket connected');
                        ws.onmessage = (ev) => {
                            try {
                                const msg = JSON.parse(ev.data);
                                this.handleMessage(msg);
                            } catch (err) {
                                console.warn('WS message parse failed:', err);
                            }
                        };
                        ws.onerror = (err) => console.warn('WebSocket error:', err);
                        ws.onclose = () => console.log('WebSocket closed');
                        this.ws = ws;
                    } catch (err) {
                        console.warn('Failed to setup WebSocket:', err);
                    }
                
                } catch (error) {
                    this.showError('Initialization failed: ' + error.message);
                }
            }
            
            setupStage() {
                // Ê∑ªÂä†ËÉåÊôØ
                this.background = new PIXI.Graphics();
                this.drawBackground();
                this.app.stage.addChild(this.background);
                
                // Ê∑ªÂä†ÊèêÁ§∫ÊñáÂ≠ó
                const style = new PIXI.TextStyle({
                    fontFamily: 'Arial',
                    fontSize: 24,
                    fill: 0xffffff,
                    align: 'center',
                    dropShadow: true,
                    dropShadowColor: 0x000000,
                    dropShadowBlur: 4,
                    dropShadowDistance: 2
                });
                
                const text = new PIXI.Text('Please select Live2D model folder', style);
                text.anchor.set(0.5);
                // ‰ΩçÁΩÆÁ®çÂêéÂú®updateCanvasSize‰∏≠ËÆæÁΩÆÔºåÊ≠§Êó∂rendererÂèØËÉΩËøòÊú™ÂÆåÂÖ®ÂàùÂßãÂåñ
                this.app.stage.addChild(text);
                this.placeholderText = text;
            }

            drawBackground() {
                this.background.clear();
                this.background.beginFill(0x667eea, 0.1);
                this.background.drawRect(0, 0, this.canvasWidth, this.canvasHeight);
                this.background.endFill();
            }

            updateCanvasSize() {
                try {
                    const canvas = this.app.view;
                    
                    // Ëé∑ÂèñÂÆπÂô®ÁöÑÂÆûÈôÖÂèØËßÅÂ∞∫ÂØ∏ÔºàCSS ÂÉèÁ¥†Ôºâ
                    let targetW = canvas.clientWidth || canvas.offsetWidth;
                    let targetH = canvas.clientHeight || canvas.offsetHeight;
                    
                    // Â¶ÇÊûúÂÆπÂô®Â∞∫ÂØ∏Êó†ÊïàÔºå‰ΩøÁî®Áà∂ÂÖÉÁ¥†ÊàñÁ™óÂè£Â∞∫ÂØ∏
                    if (!targetW || !targetH) {
                        const parent = canvas.parentElement;
                        targetW = parent ? parent.clientWidth : window.innerWidth * 0.9;
                        targetH = parent ? parent.clientHeight : window.innerHeight * 0.85;
                    }
                    
                    // Á°Æ‰øùÂ∞∫ÂØ∏ÂêàÁêÜÔºà‰ΩøÁî®Êï¥Êï∞ÈÅøÂÖçÊ®°Á≥äÔºâ
                    targetW = Math.floor(Math.max(400, Math.min(targetW, window.innerWidth * 0.95)));
                    targetH = Math.floor(Math.max(300, Math.min(targetH, window.innerHeight * 0.95)));
                    
                    // ‰øùÂ≠òÂÆûÈôÖÁöÑCSSÂÉèÁ¥†Â∞∫ÂØ∏
                    this.canvasWidth = targetW;
                    this.canvasHeight = targetH;
                    
                    console.log(`Updating canvas size to: ${targetW}x${targetH} (CSS pixels), DPR: ${window.devicePixelRatio}`);
                    
                    // Êõ¥Êñ∞Ê∏≤ÊüìÂô®Â∞∫ÂØ∏
                    this.app.renderer.resize(targetW, targetH);
                    
                    // Êõ¥Êñ∞ canvas ÁöÑ CSS Â∞∫ÂØ∏‰ª•ÂåπÈÖç
                    canvas.style.width = targetW + 'px';
                    canvas.style.height = targetH + 'px';
                    
                    // ÈáçÁªòËÉåÊôØ
                    this.drawBackground();
                    
                    // Êõ¥Êñ∞Âç†‰ΩçÁ¨¶‰ΩçÁΩÆÔºà‰ΩøÁî®Ê∏≤ÊüìÂô®ÁöÑÈÄªËæëÂ∞∫ÂØ∏ÔºåÂç≥resize‰º†ÂÖ•ÁöÑÂ∞∫ÂØ∏Ôºâ
                    if (this.placeholderText) {
                        this.placeholderText.x = targetW / 2;
                        this.placeholderText.y = targetH / 2;
                        console.log(`Placeholder text positioned at: ${this.placeholderText.x}, ${this.placeholderText.y}`);
                    }
                    
                    // Â¶ÇÊûúÊúâÊ®°ÂûãÔºåÈáçÊñ∞ÈÄÇÈÖçÂà∞ËßÜÂõæ‰∏≠ÂøÉ
                    if (this.model) {
                        setTimeout(() => {
                            this.fitModelToView({ mode: 'contain', margin: 50, alignX: 0.5, alignY: 0.5 });
                        }, 10);
                    }
                    
                } catch (error) {
                    console.warn('Error updating canvas size:', error);
                }
            }
            
            handleMessage(data) {
                try {
                    switch(data.type) {
                        case 'loadModel':
                            // ‰ºòÂÖà‰ΩøÁî®file:// URLÔºåÈÅøÂÖçWindowsÊú¨Âú∞Ë∑ØÂæÑÂØºËá¥Âä†ËΩΩÂ§±Ë¥•
                            this.loadModel(data.modelUrl || data.modelPath, data.modelData);
                            break;
                        case 'setExpression':
                            this.setExpression(data.expression);
                            break;
                        case 'playMotion':
                            this.playMotion(data.motion);
                            break;
                        case 'setParameter':
                            this.setParameter(data.parameter, data.value);
                            break;
                        case 'toggleInfo':
                            this.toggleInfoPanel(typeof data.visible === 'boolean' ? data.visible : undefined);
                            break;
                        case 'setCanvasOpacity':
                            this.setCanvasOpacity(data.opacity);
                            break;
                        case 'setRotationAngle':
                            this.setRotationAngle(data.angle);
                            break;
                        case 'setBackground':
                            this.setBackground(data.transparent, data.color);
                            break;
                        case 'setResolution':
                            this.setResolution(data.width, data.height, data.auto);
                            break;
                        case 'clearModel':
                            this.clearModel();
                            break;
                        case 'updateCanvas':
                            this.updateCanvasSize();
                            break;
                    }
                } catch (error) {
                    this.showError('Message processing failed: ' + error.message);
                }
            }
            
            async loadModel(modelPath, modelData) {
                try {
                    // ÁßªÈô§Âç†‰ΩçÁ¨¶ÊñáÂ≠ó
                    if (this.placeholderText) {
                        this.app.stage.removeChild(this.placeholderText);
                        this.placeholderText = null;
                    }
                    
                    // ÁßªÈô§ÊóßÊ®°Âûã
                    if (this.model) {
                        this.app.stage.removeChild(this.model);
                        this.model.destroy();
                    }
                    
                    this.modelData = modelData;
                    
                    // Â∞ùËØïÂä†ËΩΩLive2DÊ®°Âûã
                    if (typeof PIXI !== 'undefined' && PIXI.live2d) {
                        // ‰ΩøÁî®Live2D Cubism SDK
                        this.model = await PIXI.live2d.Live2DModel.from(modelPath);
                        
                        // Ê∑ªÂä†Âà∞ËàûÂè∞
                        this.app.stage.addChild(this.model);

                        // Á≠âÂæÖ‰∏ÄÂ∏ßÂêéËøõË°åÂàùÂßãÂåñÔºåÁ°Æ‰øùÊ®°ÂûãÂÆåÂÖ®Âä†ËΩΩ
                        await new Promise(resolve => requestAnimationFrame(resolve));
                        
                        // Á°Æ‰øùÊ®°ÂûãÂèØËßÅ
                        this.model.visible = true;
                        this.model.alpha = 1.0;
                        
                        // ËÆæÁΩÆÊ®°ÂûãËá™ÈÄÇÂ∫î‰ΩçÁΩÆ‰∏éÁº©ÊîæÔºà‰ΩøÁî®Êõ¥Â§ßÁöÑËæπË∑ùÔºâ
                        this.fitModelToView({ mode: 'contain', margin: 50, alignX: 0.5, alignY: 0.5 });
                        
                        // Âº∫Âà∂Ê∏≤Êüì‰∏ÄÊ¨°
                        this.app.renderer.render(this.app.stage);
                        
                        // ÂêØÁî®‰∫§‰∫í
                        this.model.interactive = true;
                        this.model.on('pointerdown', () => {
                            // Â¶ÇÊûúÊúâÂΩìÂâçÈÄâ‰∏≠ÁöÑÂä®‰ΩúÔºåÊí≠ÊîæÈÄâ‰∏≠ÁöÑÂä®‰ΩúÔºõÂê¶ÂàôÊí≠ÊîæÈöèÊú∫Âä®‰Ωú
                            if (this.currentMotion) {
                                try { 
                                    this.playMotion(this.currentMotion); 
                                } catch (e) { 
                                    console.warn('Êí≠ÊîæÈÄâ‰∏≠Âä®‰ΩúÂ§±Ë¥•:', e); 
                                }
                            } else {
                                const groups = this.getMotionGroups();
                                if (groups.length > 0) {
                                    const group = groups[Math.floor(Math.random() * groups.length)];
                                    try { 
                                        this.model.motion(group);
                                        document.getElementById('motion-info').textContent = `Motion: ${group} (random)`;
                                    } catch (e) { 
                                        console.warn('ÈöèÊú∫Âä®‰ΩúÂ§±Ë¥•:', e); 
                                    }
                                } else {
                                    console.warn('Êó†ÂèØÁî®Âä®‰ΩúÂàÜÁªÑ');
                                }
                            }
                        });
                        
                    } else {
                        throw new Error('Live2D library not loaded');
                    }
                    
                    // Êõ¥Êñ∞UI
                    const name = (modelPath || '').split(/[\\\/]/).pop();
                    document.getElementById('model-info').textContent = `Model: ${name || 'Unknown'}`;
                    
                    // Âª∂ËøüÈáçÊñ∞ÈÄÇÈÖçÔºåÁ°Æ‰øùÊ®°ÂûãÂÆåÂÖ®ÂàùÂßãÂåñÔºà‰ΩøÁî®Êõ¥Â§ßÁöÑËæπË∑ùÔºâ
                    setTimeout(() => {
                        this.fitModelToView({ mode: 'contain', margin: 50, alignX: 0.5, alignY: 0.5 });
                        this.app.renderer.render(this.app.stage);
                    }, 100);
                    
                    // ÂÜçÊ¨°Âª∂ËøüÈÄÇÈÖçÔºåÁ°Æ‰øùÂú®È´ò DPI ÊòæÁ§∫Âô®‰∏ä‰πüËÉΩÊ≠£Á°ÆÂ±Ö‰∏≠
                    setTimeout(() => {
                        this.fitModelToView({ mode: 'contain', margin: 50, alignX: 0.5, alignY: 0.5 });
                    }, 300);
                    
                    this.sendMessage('modelLoaded', { path: modelPath });
                    
                } catch (error) {
                    console.error('Ê®°ÂûãÂä†ËΩΩÂ§±Ë¥•:', error);
                    this.showError('Model loading failed: ' + error.message);
                    this.sendMessage('modelLoadError', { path: modelPath, error: error.message });
                }
            }

            // Ëá™ÈÄÇÂ∫îÊ®°ÂûãÂà∞ËßÜÂè£ÔºöÊ†πÊçÆÂèØÁî®Âå∫ÂüüËá™Âä®Áº©ÊîæÂπ∂Â±Ö‰∏≠
            fitModelToView(options = {}) {
                if (!this.app || !this.model) {
                    console.warn('Cannot fit model to view: app or model not available');
                    return;
                }

                try {
                    const mode = options.mode || 'contain'; // 'contain' Êàñ 'cover'
                    const margin = options.margin ?? 50;  // Â¢ûÂä†ËæπË∑ùÈÅøÂÖçÊ®°ÂûãË¥¥Ëæπ
                    const alignX = options.alignX ?? 0.5;   // 0.0 Â∑¶, 0.5 ‰∏≠, 1.0 Âè≥
                    const alignY = options.alignY ?? 0.5;   // 0.0 ‰∏ä, 0.5 ‰∏≠, 1.0 ‰∏ã

                    // ‰ΩøÁî®ÂÆûÈôÖÁöÑCSSÂÉèÁ¥†Â∞∫ÂØ∏
                    const stageW = this.canvasWidth;
                    const stageH = this.canvasHeight;
                    const availW = Math.max(100, stageW - margin * 2);
                    const availH = Math.max(100, stageH - margin * 2);

                    console.log(`Stage size: ${stageW}x${stageH}, Available: ${availW}x${availH}`);

                    // Ëé∑ÂèñÊ®°ÂûãÊú¨Âú∞ËæπÁïåÔºà‰∏çÂèóÁà∂Á∫ßÁº©ÊîæÂΩ±ÂìçÔºâ
                    const localBounds = this.model.getLocalBounds();
                    const w0 = Math.max(1, localBounds.width);
                    const h0 = Math.max(1, localBounds.height);
                    
                    console.log(`Model bounds: ${w0}x${h0}, position: (${localBounds.x}, ${localBounds.y})`);

                    // ËÆ°ÁÆóÁº©ÊîæÊØî‰æãÔºåÁ°Æ‰øùÊ®°ÂûãÂÆåÂÖ®ÂèØËßÅ
                    let scale = mode === 'cover'
                        ? Math.max(availW / w0, availH / h0)
                        : Math.min(availW / w0, availH / h0);
                    
                    // Á°Æ‰øùÁº©ÊîæÊØî‰æãÂêàÁêÜ‰∏îÂÅè‰øùÂÆàÔºàÂÆÅÂèØÂ∞è‰∏ÄÁÇπ‰πüË¶ÅÁ°Æ‰øùÂ±Ö‰∏≠Ôºâ
                    scale = Math.max(0.1, Math.min(scale * 0.9, 5));  // ‰πò‰ª• 0.9 ÁïôÂá∫Êõ¥Â§öÁ©∫Èó¥

                    this.model.scale.set(scale);
                    
                    // Â∞ÜÈîöÁÇπËÆæÁΩÆÂà∞Ê®°ÂûãËæπÁïåÁöÑ‰∏≠ÂøÉ
                    this.model.pivot.set(localBounds.x + w0 / 2, localBounds.y + h0 / 2);
                    
                    // Â∞ÜÊ®°ÂûãÂÆö‰ΩçÂà∞ËàûÂè∞‰∏≠ÂøÉÔºàÊàñÊ†πÊçÆÂØπÈΩêÂèÇÊï∞ÂÆö‰ΩçÔºâ
                    const posX = margin + availW * alignX;
                    const posY = margin + availH * alignY;
                    
                    this.model.position.set(posX, posY);
                    
                    console.log(`Model fitted: scale=${scale.toFixed(3)}, pivot=(${this.model.pivot.x.toFixed(1)}, ${this.model.pivot.y.toFixed(1)}), position=(${posX.toFixed(1)}, ${posY.toFixed(1)})`);
                    
                    // Âº∫Âà∂Ê∏≤Êüì‰∏ÄÂ∏ß
                    this.app.renderer.render(this.app.stage);
                    
                } catch (error) {
                    console.warn('Error fitting model to view:', error);
                }
            }
            
            setExpression(expression) {
                this.currentExpression = expression;
                
                if (this.model && this.model.internalModel && this.model.internalModel.coreModel) {
                    // ÁúüÂÆûLive2DÊ®°Âûã
                    try {
                        this.model.expression(expression);
                    } catch (error) {
                        console.warn('ËÆæÁΩÆË°®ÊÉÖÂ§±Ë¥•:', error);
                    }
                }
                
                document.getElementById('expression-info').textContent = `Expression: ${expression}`;
                this.sendMessage('expressionChanged', { expression: expression });
            }
            
            playMotion(motionData) {
                // ÊîØÊåÅ‰∏§ÁßçË∞ÉÁî®ÊñπÂºèÔºöÁõ¥Êé•‰º†Âä®‰ΩúÁªÑÂêçÂ≠óÁ¨¶‰∏≤ÔºåÊàñ‰º†ÂåÖÂê´motionÂíåindexÁöÑÂØπË±°
                let motion, index = 0;
                
                if (typeof motionData === 'string') {
                    motion = motionData;
                } else if (typeof motionData === 'object' && motionData.motion) {
                    motion = motionData.motion;
                    index = motionData.index || 0;
                } else {
                    console.warn('Invalid motion data:', motionData);
                    return;
                }
                
                this.currentMotion = motion;

                if (!this.model || !this.model.internalModel || !this.model.internalModel.coreModel) {
                    document.getElementById('motion-info').textContent = `Motion: No available motions`;
                    this.sendMessage('motionPlayed', { motion: motion, ok: false, groups: [] });
                    return;
                }

                try {
                    const groups = this.getMotionGroups();
                    const requested = String(motion || '').trim();
                    let group = requested;

                    // Â¶ÇÊûúÁªÑÂêç‰∏çÂ≠òÂú®ÔºåÂ∞ùËØïÂõûÈÄÄÁ≠ñÁï•
                    if (!groups.includes(group)) {
                        console.warn(`Motion group "${group}" not found. Available groups:`, groups);
                        
                        // Â∞ùËØïÂ∏∏ËßÅÁöÑÂä®‰ΩúÁªÑÂêç
                        const commonGroups = ['idle', 'Idle', 'IDLE', 'tap_body', 'Tap', 'TapBody', 'tap'];
                        const fallbackGroup = commonGroups.find(g => groups.includes(g));
                        
                        if (fallbackGroup) {
                            group = fallbackGroup;
                            console.log(`Using fallback group: ${group}`);
                        } else if (groups.length > 0) {
                            group = groups[0];
                            console.log(`Using first available group: ${group}`);
                        } else {
                            document.getElementById('motion-info').textContent = `Motion: No available motions`;
                            this.sendMessage('motionPlayed', { motion: requested, ok: false, groups });
                            return;
                        }
                    }

                    // Êí≠ÊîæÂä®‰Ωú - ‰ΩøÁî®Âä®‰ΩúÁªÑÂêçÂíåÁ¥¢Âºï
                    if (typeof index === 'number' && index >= 0) {
                        // Â¶ÇÊûúÊèê‰æõ‰∫ÜÁ¥¢ÂºïÔºåÂ∞ùËØïÊí≠ÊîæÁâπÂÆöÁ¥¢ÂºïÁöÑÂä®‰Ωú
                        this.model.motion(group, index);
                    } else {
                        // Âê¶ÂàôÊí≠ÊîæÁªÑ‰∏≠ÁöÑÈöèÊú∫Âä®‰Ωú
                        this.model.motion(group);
                    }
                    
                    document.getElementById('motion-info').textContent = `Motion: ${group}${index !== undefined ? ` [${index}]` : ''}`;
                    this.sendMessage('motionPlayed', { 
                        motion: group, 
                        index: index,
                        ok: true, 
                        groups, 
                        original: requested 
                    });
                    
                } catch (error) {
                    console.warn('Failed to play motion:', error);
                    document.getElementById('motion-info').textContent = `Motion: Failed(${motion})`;
                    this.sendMessage('motionPlayed', { motion, ok: false, error: error.message });
                }
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('canvas').style.display = 'none';
                document.getElementById('info').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            }
            
            sendMessage(type, data) {
                // ÈÄöËøáÊéßÂà∂Âè∞ËæìÂá∫Ê∂àÊÅØÔºåPythonÁ´ØÂèØ‰ª•ÁõëÂê¨
                console.log(JSON.stringify({ type: type, data: data }));
            }

            getMotionGroups() {
                const settings = this.model && this.model.internalModel ? this.model.internalModel.settings : null;
                const motions = settings && settings.motions ? settings.motions : null;
                return motions ? Object.keys(motions) : [];
            }
            
            setCanvasOpacity(opacity) {
                if (this.model) {
                    this.model.alpha = Math.max(0, Math.min(1, opacity));
                    this.sendMessage('canvasOpacityChanged', { opacity: this.model.alpha });
                }
            }
            
            setRotationAngle(angle) {
                if (this.model) {
                    // Â∞ÜËßíÂ∫¶ËΩ¨Êç¢‰∏∫ÂºßÂ∫¶
                    this.model.rotation = (angle * Math.PI) / 180;
                    this.sendMessage('rotationAngleChanged', { angle: angle });
                }
            }
            
            setBackground(transparent, color) {
                if (transparent) {
                    // ËÆæÁΩÆÈÄèÊòéËÉåÊôØ
                    this.background.clear();
                    this.app.renderer.backgroundColor = 0x000000;
                    this.app.renderer.backgroundAlpha = 0;
                } else {
                    // ËÆæÁΩÆÂΩ©Ëâ≤ËÉåÊôØ
                    const colorValue = color ? parseInt(color.replace('#', ''), 16) : 0xffffff;
                    this.background.clear();
                    this.background.beginFill(colorValue, 1);
                    this.background.drawRect(0, 0, this.canvasWidth, this.canvasHeight);
                    this.background.endFill();
                    this.app.renderer.backgroundColor = colorValue;
                    this.app.renderer.backgroundAlpha = 1;
                }
                this.sendMessage('backgroundChanged', { transparent: transparent, color: color });
            }
            
            setResolution(width, height, auto) {
                if (!this.app) return;
                
                try {
                    if (auto) {
                        // Ëá™Âä®ÈÄÇÂ∫îÂÆπÂô®Â§ßÂ∞è
                        this.updateCanvasSize();
                    } else {
                        // ËÆæÁΩÆÂõ∫ÂÆöÂàÜËæ®Áéá
                        const canvas = this.app.view;
                        const targetWidth = Math.max(100, width || 800);
                        const targetHeight = Math.max(100, height || 600);
                        
                        // ‰øùÂ≠òÂÆûÈôÖÁöÑCSSÂÉèÁ¥†Â∞∫ÂØ∏
                        this.canvasWidth = targetWidth;
                        this.canvasHeight = targetHeight;
                        
                        // Êõ¥Êñ∞Ê∏≤ÊüìÂô®Â∞∫ÂØ∏
                        this.app.renderer.resize(targetWidth, targetHeight);
                        
                        // Êõ¥Êñ∞canvasÊ†∑ÂºèÂ∞∫ÂØ∏‰ª•‰øùÊåÅÊ∏ÖÊô∞Â∫¶
                        canvas.style.width = targetWidth + 'px';
                        canvas.style.height = targetHeight + 'px';
                        
                        // ÈáçÁªòËÉåÊôØ
                        this.drawBackground();
                        
                        // ÈáçÊñ∞ÈÄÇÈÖçÊ®°Âûã
                        this.fitModelToView();
                        
                        this.sendMessage('resolutionChanged', { 
                            width: targetWidth, 
                            height: targetHeight, 
                            auto: false 
                        });
                    }
                } catch (error) {
                    console.warn('Failed to set resolution:', error);
                    this.sendMessage('resolutionChanged', { 
                        error: error.message, 
                        width: width, 
                        height: height, 
                        auto: auto 
                    });
                }
            }
            
            clearModel() {
                try {
                    // ÁßªÈô§ÂΩìÂâçÊ®°Âûã
                    if (this.model) {
                        this.app.stage.removeChild(this.model);
                        this.model.destroy();
                        this.model = null;
                    }
                    
                    // Ê∏ÖÁêÜÊ®°ÂûãÊï∞ÊçÆ
                    this.modelData = null;
                    this.currentExpression = null;
                    this.currentMotion = null;
                    
                    // ÈáçÁΩÆUI‰ø°ÊÅØ
                    document.getElementById('model-info').textContent = 'Model: Not loaded';
                    document.getElementById('expression-info').textContent = 'Expression: None';
                    document.getElementById('motion-info').textContent = 'Motion: None';
                    
                    // ÊòæÁ§∫Âç†‰ΩçÁ¨¶ÊñáÂ≠ó
                    this.showPlaceholder();
                    
                    // ÈÄöÁü•PythonÁ´Ø
                    this.sendMessage('modelCleared', {});
                    
                } catch (error) {
                    console.warn('Failed to clear model:', error);
                    this.sendMessage('modelClearError', { error: error.message });
                }
            }
            
            showPlaceholder() {
                // Ê∑ªÂä†Âç†‰ΩçÁ¨¶ÊñáÂ≠ó
                if (!this.placeholderText && this.app) {
                    this.placeholderText = new PIXI.Text('Drag & Drop Live2D Model Here\nor\nSelect Model Folder', {
                        fontFamily: 'Arial',
                        fontSize: 24,
                        fill: 0xffffff,
                        align: 'center'
                    });
                    this.placeholderText.anchor.set(0.5);
                    this.placeholderText.x = this.canvasWidth / 2;
                    this.placeholderText.y = this.canvasHeight / 2;
                    this.app.stage.addChild(this.placeholderText);
                }
            }
            
            toggleInfoPanel(force) {
                const infoEl = document.getElementById('info');
                const toggleBtn = document.getElementById('toggle-info');
                
                if (typeof force === 'boolean') {
                    this.infoVisible = force;
                } else {
                    this.infoVisible = !this.infoVisible;
                }
                
                if (this.infoVisible) {
                    infoEl.style.display = 'block';
                    if (toggleBtn) toggleBtn.textContent = 'Hide Panel [H]';
                } else {
                    infoEl.style.display = 'none';
                    if (toggleBtn) toggleBtn.textContent = 'Show Panel [H]';
                }
            }
        }
        
        // ÂàùÂßãÂåñÈ¢ÑËßàÂô®
        window.addEventListener('load', () => {
            window.live2dPreview = new Live2DPreview();
        });
    </script>
</body>
</html>