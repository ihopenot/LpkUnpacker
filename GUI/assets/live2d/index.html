<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Live2D Preview</title>
    <!-- Live2D Cubism Core (v4) & Live2D v2 runtime -->
    <script src="../vender/live2dcubismcore.min.js"></script>
    <script src="../vender/live2d.min.js"></script>

    <!-- PixiJS v6 and expose to window for plugin -->
    <script src="../vender/pixi.min.js"></script>
    <script>
        window.PIXI = PIXI;
    </script>

    <!-- pixi-live2d-displayÔºàÂêåÊó∂ÊîØÊåÅ Cubism 2.1 ‰∏é 4Ôºâ -->
    <script src="../vender/index.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        #canvas {
            border: 2px solid #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.1);
            width: 90vw;
            height: 85vh;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        #ui-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        #toggle-info {
            appearance: none;
            border: none;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }
        #toggle-info:hover { background: rgba(0,0,0,0.75); }
        .info-section {
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .info-section:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: bold;
            color: #ffd93d;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>Preparing Live2D Previewer...</div>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
            Loading rendering engine...
        </div>
    </div>
    
    <div id="error" style="display: none;">
        <h3>‚ùå Loading Failed</h3>
        <p id="error-message">Unknown error</p>
        <div style="font-size: 12px; margin-top: 15px; opacity: 0.8;">
            Please check network connection or refresh page to retry
        </div>
    </div>
    
    <div id="info" style="display: none;">
        <div class="info-section">
            <div class="info-label">üé≠ Live2D Web Previewer</div>
        </div>
        <div class="info-section">
            <div class="info-label">Model Info</div>
            <div id="model-info">No model loaded</div>
        </div>
        <div class="info-section">
            <div class="info-label">Expression</div>
            <div id="expression-info">None</div>
        </div>
        <div class="info-section">
            <div class="info-label">Motion</div>
            <div id="motion-info">None</div>
        </div>
    </div>
    <div id="ui-controls">
        <button id="toggle-info" title="Shortcut: H or Double-click canvas">Hide Panel [H]</button>
    </div>
    
    <canvas id="canvas" width="800" height="600" style="display: none;"></canvas>
    
    <script>
        // Live2D WebÈ¢ÑËßàÂô® - ‰ΩøÁî®PIXI.jsÂíåLive2D Cubism SDK
        class Live2DPreview {
            constructor() {
                this.app = null;
                this.model = null;
                this.modelData = null;
                this.currentExpression = null;
                this.currentMotion = null;
                this.init();
            }
            
            async init() {
                try {
                    // Ê£ÄÊü•Live2D SDKÊòØÂê¶Âä†ËΩΩ
                    if (typeof PIXI === 'undefined') {
                        throw new Error('PIXI.js not loaded');
                    }
                    
                    // ÂàùÂßãÂåñPIXIÂ∫îÁî®
                    this.app = new PIXI.Application({
                        view: document.getElementById('canvas'),
                        width: 800,
                        height: 600,
                        backgroundColor: 0x1099bb,
                        backgroundAlpha: 0.1
                    });
                    
                    // ËÆæÁΩÆËàûÂè∞
                    this.setupStage();

                    // Ê†πÊçÆËßÜÂè£Â∞∫ÂØ∏Ëá™ÈÄÇÂ∫îÊ∏≤ÊüìÂô®Â§ßÂ∞è
                    this.updateCanvasSize();
                    window.addEventListener('resize', () => {
                        this.updateCanvasSize();
                        this.fitModelToView();
                    });
                    
                    // ÁõëÂê¨Êù•Ëá™PythonÁöÑÊ∂àÊÅØ
                    window.addEventListener('message', (event) => {
                        this.handleMessage(event.data);
                    });
                    
                    // ÊòæÁ§∫ÁîªÂ∏ÉÂíå‰ø°ÊÅØÈù¢Êùø
                    document.getElementById('canvas').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('info').style.display = 'block';
                    this.infoVisible = true;
                    const toggleBtn = document.getElementById('toggle-info');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', () => this.toggleInfoPanel());
                    }
                    window.addEventListener('keydown', (e) => {
                        if (e.key === 'h' || e.key === 'H') this.toggleInfoPanel();
                    });
                    // ÂèåÂáªÁîªÂ∏ÉÂø´ÈÄüÂºÄÂÖ≥
                    this.app.view.addEventListener('dblclick', () => this.toggleInfoPanel());
                    
                    // ÈÄöÁü•PythonÈ¢ÑËßàÂô®Â∑≤ÂáÜÂ§áÂ∞±Áª™
                    this.sendMessage('ready', {});
                    
                } catch (error) {
                    this.showError('Initialization failed: ' + error.message);
                }
            }
            
            setupStage() {
                // Ê∑ªÂä†ËÉåÊôØ
                this.background = new PIXI.Graphics();
                this.drawBackground();
                this.app.stage.addChild(this.background);
                
                // Ê∑ªÂä†ÊèêÁ§∫ÊñáÂ≠ó
                const style = new PIXI.TextStyle({
                    fontFamily: 'Arial',
                    fontSize: 24,
                    fill: 0xffffff,
                    align: 'center',
                    dropShadow: true,
                    dropShadowColor: 0x000000,
                    dropShadowBlur: 4,
                    dropShadowDistance: 2
                });
                
                const text = new PIXI.Text('Please select Live2D model folder', style);
                text.anchor.set(0.5);
                text.x = this.app.renderer.width / 2;
                text.y = this.app.renderer.height / 2;
                this.app.stage.addChild(text);
                this.placeholderText = text;
            }

            drawBackground() {
                this.background.clear();
                this.background.beginFill(0x667eea, 0.1);
                this.background.drawRect(0, 0, this.app.renderer.width, this.app.renderer.height);
                this.background.endFill();
            }

            updateCanvasSize() {
                const canvas = this.app.view;
                const targetW = Math.max(1, canvas.clientWidth || window.innerWidth);
                const targetH = Math.max(1, canvas.clientHeight || window.innerHeight);
                this.app.renderer.resize(targetW, targetH);
                this.drawBackground();
                if (this.placeholderText) {
                    this.placeholderText.x = this.app.renderer.width / 2;
                    this.placeholderText.y = this.app.renderer.height / 2;
                }
            }
            
            handleMessage(data) {
                try {
                    switch(data.type) {
                        case 'loadModel':
                            // ‰ºòÂÖà‰ΩøÁî®file:// URLÔºåÈÅøÂÖçWindowsÊú¨Âú∞Ë∑ØÂæÑÂØºËá¥Âä†ËΩΩÂ§±Ë¥•
                            this.loadModel(data.modelUrl || data.modelPath, data.modelData);
                            break;
                        case 'setExpression':
                            this.setExpression(data.expression);
                            break;
                        case 'playMotion':
                            this.playMotion(data.motion);
                            break;
                        case 'setParameter':
                            this.setParameter(data.parameter, data.value);
                            break;
                        case 'toggleInfo':
                            this.toggleInfoPanel(typeof data.visible === 'boolean' ? data.visible : undefined);
                            break;
                        case 'setCanvasOpacity':
                            this.setCanvasOpacity(data.opacity);
                            break;
                        case 'setRotationAngle':
                            this.setRotationAngle(data.angle);
                            break;
                        case 'setBackground':
                            this.setBackground(data.transparent, data.color);
                            break;
                    }
                } catch (error) {
                    this.showError('Message processing failed: ' + error.message);
                }
            }
            
            async loadModel(modelPath, modelData) {
                try {
                    // ÁßªÈô§Âç†‰ΩçÁ¨¶ÊñáÂ≠ó
                    if (this.placeholderText) {
                        this.app.stage.removeChild(this.placeholderText);
                        this.placeholderText = null;
                    }
                    
                    // ÁßªÈô§ÊóßÊ®°Âûã
                    if (this.model) {
                        this.app.stage.removeChild(this.model);
                        this.model.destroy();
                    }
                    
                    this.modelData = modelData;
                    
                    // Â∞ùËØïÂä†ËΩΩLive2DÊ®°Âûã
                    if (typeof PIXI !== 'undefined' && PIXI.live2d) {
                        // ‰ΩøÁî®Live2D Cubism SDK
                        this.model = await PIXI.live2d.Live2DModel.from(modelPath);
                        
                        // Ê∑ªÂä†Âà∞ËàûÂè∞
                        this.app.stage.addChild(this.model);

                        // ËÆæÁΩÆÊ®°ÂûãËá™ÈÄÇÂ∫î‰ΩçÁΩÆ‰∏éÁº©Êîæ
                        this.fitModelToView({ mode: 'contain', margin: 20, alignX: 0.5, alignY: 0.5 });
                        
                        // ÂêØÁî®‰∫§‰∫í
                        this.model.interactive = true;
                        this.model.on('pointerdown', () => {
                            const groups = this.getMotionGroups();
                            if (groups.length > 0) {
                                const group = groups[Math.floor(Math.random() * groups.length)];
                                try { this.model.motion(group); } catch (e) { console.warn('ÈöèÊú∫Âä®‰ΩúÂ§±Ë¥•:', e); }
                            } else {
                                console.warn('Êó†ÂèØÁî®Âä®‰ΩúÂàÜÁªÑ');
                            }
                        });
                        
                    } else {
                        throw new Error('Live2D library not loaded');
                    }
                    
                    // Êõ¥Êñ∞UI
                    const name = (modelPath || '').split(/[\\\/]/).pop();
                    document.getElementById('model-info').textContent = `Model: ${name || 'Unknown'}`;
                    this.sendMessage('modelLoaded', { path: modelPath });
                    
                } catch (error) {
                    console.error('Ê®°ÂûãÂä†ËΩΩÂ§±Ë¥•:', error);
                    this.showError('Model loading failed: ' + error.message);
                    this.sendMessage('modelLoadError', { path: modelPath, error: error.message });
                }
            }

            // Ëá™ÈÄÇÂ∫îÊ®°ÂûãÂà∞ËßÜÂè£ÔºöÊ†πÊçÆÂèØÁî®Âå∫ÂüüËá™Âä®Áº©ÊîæÂπ∂Â±Ö‰∏≠
            fitModelToView(options = {}) {
                if (!this.app || !this.model) return;

                const mode = options.mode || 'contain'; // 'contain' Êàñ 'cover'
                const margin = options.margin ?? 20;
                const alignX = options.alignX ?? 0.5;   // 0.0 Â∑¶, 0.5 ‰∏≠, 1.0 Âè≥
                const alignY = options.alignY ?? 0.5;   // 0.0 ‰∏ä, 0.5 ‰∏≠, 1.0 ‰∏ã

                const stageW = this.app.renderer.width;
                const stageH = this.app.renderer.height;
                const availW = Math.max(1, stageW - margin * 2);
                const availH = Math.max(1, stageH - margin * 2);

                // Ëé∑ÂèñÊ®°ÂûãÊú¨Âú∞ËæπÁïåÔºà‰∏çÂèóÁà∂Á∫ßÁº©ÊîæÂΩ±ÂìçÔºâ
                const localBounds = this.model.getLocalBounds();
                const w0 = Math.max(1, localBounds.width);
                const h0 = Math.max(1, localBounds.height);

                const scale = mode === 'cover'
                    ? Math.max(availW / w0, availH / h0)
                    : Math.min(availW / w0, availH / h0);

                this.model.scale.set(scale);
                // Â∞ÜÂéüÁÇπÁßªÂà∞‰∏≠ÂøÉ‰ª•‰æøÂ±Ö‰∏≠ÂÆö‰Ωç
                this.model.pivot.set(localBounds.x + w0 / 2, localBounds.y + h0 / 2);
                // Ê†πÊçÆÂØπÈΩêÂèÇÊï∞ÂÆö‰Ωç
                this.model.position.set(margin + availW * alignX, margin + availH * alignY);
            }
            
            setExpression(expression) {
                this.currentExpression = expression;
                
                if (this.model && this.model.internalModel && this.model.internalModel.coreModel) {
                    // ÁúüÂÆûLive2DÊ®°Âûã
                    try {
                        this.model.expression(expression);
                    } catch (error) {
                        console.warn('ËÆæÁΩÆË°®ÊÉÖÂ§±Ë¥•:', error);
                    }
                }
                
                document.getElementById('expression-info').textContent = `Expression: ${expression}`;
                this.sendMessage('expressionChanged', { expression: expression });
            }
            
            playMotion(motion) {
                this.currentMotion = motion;

                if (!this.model || !this.model.internalModel || !this.model.internalModel.coreModel) {
                    document.getElementById('motion-info').textContent = `Motion: No available motions`;
                    this.sendMessage('motionPlayed', { motion: requested, ok: false, groups });
                    return;
                }

                try {
                    const groups = this.getMotionGroups();
                    const requested = String(motion || '').trim();
                    let group = requested;

                    if (!groups.includes(group)) {
                        const idles = ['idle','Idle','IDLE'];
                        const taps = ['tap_body','Tap','TapBody','tap'];
                        if (idles.some(s => groups.includes(s))) group = idles.find(s => groups.includes(s));
                        else if (taps.some(s => groups.includes(s))) group = taps.find(s => groups.includes(s));
                        else if (groups.length > 0) group = groups[0];
                        else {
                            document.getElementById('motion-info').textContent = `Motion: No available motions`;
                            this.sendMessage('motionPlayed', { motion: requested, ok: false, groups });
                            return;
                        }
                    }

                    this.model.motion(group);
                    document.getElementById('motion-info').textContent = `Motion: ${group}`;
                    this.sendMessage('motionPlayed', { motion: group, ok: true, groups });
                } catch (error) {
                    console.warn('Failed to play motion:', error);
                    document.getElementById('motion-info').textContent = `Motion: Failed(${motion})`;
                    this.sendMessage('motionPlayed', { motion, ok: false, error: error.message });
                }
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('canvas').style.display = 'none';
                document.getElementById('info').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            }
            
            sendMessage(type, data) {
                // ÈÄöËøáÊéßÂà∂Âè∞ËæìÂá∫Ê∂àÊÅØÔºåPythonÁ´ØÂèØ‰ª•ÁõëÂê¨
                console.log(JSON.stringify({ type: type, data: data }));
            }

            getMotionGroups() {
                const settings = this.model && this.model.internalModel ? this.model.internalModel.settings : null;
                const motions = settings && settings.motions ? settings.motions : null;
                return motions ? Object.keys(motions) : [];
            }
            
            setCanvasOpacity(opacity) {
                if (this.model) {
                    this.model.alpha = Math.max(0, Math.min(1, opacity));
                    this.sendMessage('canvasOpacityChanged', { opacity: this.model.alpha });
                }
            }
            
            setRotationAngle(angle) {
                if (this.model) {
                    // Â∞ÜËßíÂ∫¶ËΩ¨Êç¢‰∏∫ÂºßÂ∫¶
                    this.model.rotation = (angle * Math.PI) / 180;
                    this.sendMessage('rotationAngleChanged', { angle: angle });
                }
            }
            
            setBackground(transparent, color) {
                if (transparent) {
                    // ËÆæÁΩÆÈÄèÊòéËÉåÊôØ
                    this.background.clear();
                    this.app.renderer.backgroundColor = 0x000000;
                    this.app.renderer.backgroundAlpha = 0;
                } else {
                    // ËÆæÁΩÆÂΩ©Ëâ≤ËÉåÊôØ
                    const colorValue = color ? parseInt(color.replace('#', ''), 16) : 0xffffff;
                    this.background.clear();
                    this.background.beginFill(colorValue, 1);
                    this.background.drawRect(0, 0, this.app.renderer.width, this.app.renderer.height);
                    this.background.endFill();
                    this.app.renderer.backgroundColor = colorValue;
                    this.app.renderer.backgroundAlpha = 1;
                }
                this.sendMessage('backgroundChanged', { transparent: transparent, color: color });
            }
            
            toggleInfoPanel(force) {
                const infoEl = document.getElementById('info');
                const toggleBtn = document.getElementById('toggle-info');
                
                if (typeof force === 'boolean') {
                    this.infoVisible = force;
                } else {
                    this.infoVisible = !this.infoVisible;
                }
                
                if (this.infoVisible) {
                    infoEl.style.display = 'block';
                    if (toggleBtn) toggleBtn.textContent = 'Hide Panel [H]';
                } else {
                    infoEl.style.display = 'none';
                    if (toggleBtn) toggleBtn.textContent = 'Show Panel [H]';
                }
            }
        }
        
        // ÂàùÂßãÂåñÈ¢ÑËßàÂô®
        window.addEventListener('load', () => {
            window.live2dPreview = new Live2DPreview();
        });
    </script>
</body>
</html>