<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Live2D Preview</title>
    <!-- Live2D Cubism Core (v4) & Live2D v2 runtime -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>

    <!-- PixiJS v6 and expose to window for plugin -->
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@6.5.2/dist/browser/pixi.min.js"></script>
    <script>
        window.PIXI = PIXI;
    </script>

    <!-- pixi-live2d-displayï¼ˆåŒæ—¶æ”¯æŒ Cubism 2.1 ä¸ 4ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
        }
        #canvas {
            border: 2px solid #fff;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.1);
            width: 90vw;
            height: 85vh;
        }
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0,0,0,0.7);
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
        }
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 18px;
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        #error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff6b6b;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            max-width: 400px;
        }
        #ui-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
        #toggle-info {
            appearance: none;
            border: none;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }
        #toggle-info:hover { background: rgba(0,0,0,0.75); }
        .info-section {
            margin-bottom: 10px;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        .info-section:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: bold;
            color: #ffd93d;
        }
        .parameter-display {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
        }
    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
        <div>å‡†å¤‡Live2Dé¢„è§ˆå™¨...</div>
        <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
            æ­£åœ¨åŠ è½½æ¸²æŸ“å¼•æ“...
        </div>
    </div>
    
    <div id="error" style="display: none;">
        <h3>âŒ åŠ è½½å¤±è´¥</h3>
        <p id="error-message">æœªçŸ¥é”™è¯¯</p>
        <div style="font-size: 12px; margin-top: 15px; opacity: 0.8;">
            è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–åˆ·æ–°é¡µé¢é‡è¯•
        </div>
    </div>
    
    <div id="info" style="display: none;">
        <div class="info-section">
            <div class="info-label">ğŸ­ Live2D Webé¢„è§ˆå™¨</div>
        </div>
        <div class="info-section">
            <div class="info-label">æ¨¡å‹ä¿¡æ¯</div>
            <div id="model-info">æœªåŠ è½½æ¨¡å‹</div>
        </div>
        <div class="info-section">
            <div class="info-label">è¡¨æƒ…</div>
            <div id="expression-info">æ— </div>
        </div>
        <div class="info-section">
            <div class="info-label">åŠ¨ä½œ</div>
            <div id="motion-info">æ— </div>
        </div>
        <div class="info-section">
            <div class="info-label">å‚æ•°è°ƒèŠ‚</div>
            <div class="parameter-display">
                <span>çœ¼éƒ¨å¼€åˆ:</span>
                <span id="eye-value">100%</span>
            </div>
            <div class="parameter-display">
                <span>å˜´éƒ¨å¼€åˆ:</span>
                <span id="mouth-value">0%</span>
            </div>
            <div class="parameter-display">
                <span>å¤´éƒ¨è§’åº¦:</span>
                <span id="angle-value">0.0Â°</span>
            </div>
        </div>
    </div>
    <div id="ui-controls">
        <button id="toggle-info" title="å¿«æ·é”®ï¼šH æˆ– åŒå‡»ç”»å¸ƒ">éšè—é¢æ¿ [H]</button>
    </div>
    
    <canvas id="canvas" width="800" height="600" style="display: none;"></canvas>
    
    <script>
        // Live2D Webé¢„è§ˆå™¨ - ä½¿ç”¨PIXI.jså’ŒLive2D Cubism SDK
        class Live2DPreview {
            constructor() {
                this.app = null;
                this.model = null;
                this.modelData = null;
                this.currentExpression = null;
                this.currentMotion = null;
                this.parameters = {
                    eyeOpen: 1.0,
                    mouthOpen: 0.0,
                    angleX: 0.0,
                    angleY: 0.0,
                    angleZ: 0.0
                };
                this.init();
            }
            
            async init() {
                try {
                    // æ£€æŸ¥Live2D SDKæ˜¯å¦åŠ è½½
                    if (typeof PIXI === 'undefined') {
                        throw new Error('PIXI.jsæœªåŠ è½½');
                    }
                    
                    // åˆå§‹åŒ–PIXIåº”ç”¨
                    this.app = new PIXI.Application({
                        view: document.getElementById('canvas'),
                        width: 800,
                        height: 600,
                        backgroundColor: 0x1099bb,
                        backgroundAlpha: 0.1
                    });
                    
                    // è®¾ç½®èˆå°
                    this.setupStage();

                    // æ ¹æ®è§†å£å°ºå¯¸è‡ªé€‚åº”æ¸²æŸ“å™¨å¤§å°
                    this.updateCanvasSize();
                    window.addEventListener('resize', () => {
                        this.updateCanvasSize();
                        this.fitModelToView();
                    });
                    
                    // ç›‘å¬æ¥è‡ªPythonçš„æ¶ˆæ¯
                    window.addEventListener('message', (event) => {
                        this.handleMessage(event.data);
                    });
                    
                    // æ˜¾ç¤ºç”»å¸ƒå’Œä¿¡æ¯é¢æ¿
                    document.getElementById('canvas').style.display = 'block';
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('info').style.display = 'block';
                    this.infoVisible = true;
                    const toggleBtn = document.getElementById('toggle-info');
                    if (toggleBtn) {
                        toggleBtn.addEventListener('click', () => this.toggleInfoPanel());
                    }
                    window.addEventListener('keydown', (e) => {
                        if (e.key === 'h' || e.key === 'H') this.toggleInfoPanel();
                    });
                    // åŒå‡»ç”»å¸ƒå¿«é€Ÿå¼€å…³
                    this.app.view.addEventListener('dblclick', () => this.toggleInfoPanel());
                    
                    // é€šçŸ¥Pythoné¢„è§ˆå™¨å·²å‡†å¤‡å°±ç»ª
                    this.sendMessage('ready', {});
                    
                } catch (error) {
                    this.showError('åˆå§‹åŒ–å¤±è´¥: ' + error.message);
                }
            }
            
            setupStage() {
                // æ·»åŠ èƒŒæ™¯
                this.background = new PIXI.Graphics();
                this.drawBackground();
                this.app.stage.addChild(this.background);
                
                // æ·»åŠ æç¤ºæ–‡å­—
                const style = new PIXI.TextStyle({
                    fontFamily: 'Arial',
                    fontSize: 24,
                    fill: 0xffffff,
                    align: 'center',
                    dropShadow: true,
                    dropShadowColor: 0x000000,
                    dropShadowBlur: 4,
                    dropShadowDistance: 2
                });
                
                const text = new PIXI.Text('è¯·é€‰æ‹©Live2Dæ¨¡å‹æ–‡ä»¶å¤¹', style);
                text.anchor.set(0.5);
                text.x = this.app.renderer.width / 2;
                text.y = this.app.renderer.height / 2;
                this.app.stage.addChild(text);
                this.placeholderText = text;
            }

            drawBackground() {
                this.background.clear();
                this.background.beginFill(0x667eea, 0.1);
                this.background.drawRect(0, 0, this.app.renderer.width, this.app.renderer.height);
                this.background.endFill();
            }

            updateCanvasSize() {
                const canvas = this.app.view;
                const targetW = Math.max(1, canvas.clientWidth || window.innerWidth);
                const targetH = Math.max(1, canvas.clientHeight || window.innerHeight);
                this.app.renderer.resize(targetW, targetH);
                this.drawBackground();
                if (this.placeholderText) {
                    this.placeholderText.x = this.app.renderer.width / 2;
                    this.placeholderText.y = this.app.renderer.height / 2;
                }
            }
            
            handleMessage(data) {
                try {
                    switch(data.type) {
                        case 'loadModel':
                            // ä¼˜å…ˆä½¿ç”¨file:// URLï¼Œé¿å…Windowsæœ¬åœ°è·¯å¾„å¯¼è‡´åŠ è½½å¤±è´¥
                            this.loadModel(data.modelUrl || data.modelPath, data.modelData);
                            break;
                        case 'setExpression':
                            this.setExpression(data.expression);
                            break;
                        case 'playMotion':
                            this.playMotion(data.motion);
                            break;
                        case 'setParameter':
                            this.setParameter(data.parameter, data.value);
                            break;
                        case 'toggleInfo':
                            this.toggleInfoPanel(typeof data.visible === 'boolean' ? data.visible : undefined);
                            break;
                    }
                } catch (error) {
                    this.showError('å¤„ç†æ¶ˆæ¯å¤±è´¥: ' + error.message);
                }
            }
            
            async loadModel(modelPath, modelData) {
                try {
                    // ç§»é™¤å ä½ç¬¦æ–‡å­—
                    if (this.placeholderText) {
                        this.app.stage.removeChild(this.placeholderText);
                        this.placeholderText = null;
                    }
                    
                    // ç§»é™¤æ—§æ¨¡å‹
                    if (this.model) {
                        this.app.stage.removeChild(this.model);
                        this.model.destroy();
                    }
                    
                    this.modelData = modelData;
                    
                    // å°è¯•åŠ è½½Live2Dæ¨¡å‹
                    if (typeof PIXI !== 'undefined' && PIXI.live2d) {
                        // ä½¿ç”¨Live2D Cubism SDK
                        this.model = await PIXI.live2d.Live2DModel.from(modelPath);
                        
                        // æ·»åŠ åˆ°èˆå°
                        this.app.stage.addChild(this.model);

                        // è®¾ç½®æ¨¡å‹è‡ªé€‚åº”ä½ç½®ä¸ç¼©æ”¾
                        this.fitModelToView({ mode: 'contain', margin: 20, alignX: 0.5, alignY: 0.5 });
                        
                        // å¯ç”¨äº¤äº’
                        this.model.interactive = true;
                        this.model.on('pointerdown', () => {
                            const groups = this.getMotionGroups();
                            if (groups.length > 0) {
                                const group = groups[Math.floor(Math.random() * groups.length)];
                                try { this.model.motion(group); } catch (e) { console.warn('éšæœºåŠ¨ä½œå¤±è´¥:', e); }
                            } else {
                                console.warn('æ— å¯ç”¨åŠ¨ä½œåˆ†ç»„');
                            }
                        });
                        
                    } else {
                        throw new Error('Live2Dåº“æœªåŠ è½½');
                    }
                    
                    // æ›´æ–°UI
                    const name = (modelPath || '').split(/[\\\/]/).pop();
                    document.getElementById('model-info').textContent = `æ¨¡å‹: ${name || 'æœªçŸ¥'}`;
                    this.sendMessage('modelLoaded', { path: modelPath });
                    
                } catch (error) {
                    console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
                    this.showError('æ¨¡å‹åŠ è½½å¤±è´¥: ' + error.message);
                    this.sendMessage('modelLoadError', { path: modelPath, error: error.message });
                }
            }

            // è‡ªé€‚åº”æ¨¡å‹åˆ°è§†å£ï¼šæ ¹æ®å¯ç”¨åŒºåŸŸè‡ªåŠ¨ç¼©æ”¾å¹¶å±…ä¸­
            fitModelToView(options = {}) {
                if (!this.app || !this.model) return;

                const mode = options.mode || 'contain'; // 'contain' æˆ– 'cover'
                const margin = options.margin ?? 20;
                const alignX = options.alignX ?? 0.5;   // 0.0 å·¦, 0.5 ä¸­, 1.0 å³
                const alignY = options.alignY ?? 0.5;   // 0.0 ä¸Š, 0.5 ä¸­, 1.0 ä¸‹

                const stageW = this.app.renderer.width;
                const stageH = this.app.renderer.height;
                const availW = Math.max(1, stageW - margin * 2);
                const availH = Math.max(1, stageH - margin * 2);

                // è·å–æ¨¡å‹æœ¬åœ°è¾¹ç•Œï¼ˆä¸å—çˆ¶çº§ç¼©æ”¾å½±å“ï¼‰
                const localBounds = this.model.getLocalBounds();
                const w0 = Math.max(1, localBounds.width);
                const h0 = Math.max(1, localBounds.height);

                const scale = mode === 'cover'
                    ? Math.max(availW / w0, availH / h0)
                    : Math.min(availW / w0, availH / h0);

                this.model.scale.set(scale);
                // å°†åŸç‚¹ç§»åˆ°ä¸­å¿ƒä»¥ä¾¿å±…ä¸­å®šä½
                this.model.pivot.set(localBounds.x + w0 / 2, localBounds.y + h0 / 2);
                // æ ¹æ®å¯¹é½å‚æ•°å®šä½
                this.model.position.set(margin + availW * alignX, margin + availH * alignY);
            }
            
            setExpression(expression) {
                this.currentExpression = expression;
                
                if (this.model && this.model.internalModel && this.model.internalModel.coreModel) {
                    // çœŸå®Live2Dæ¨¡å‹
                    try {
                        this.model.expression(expression);
                    } catch (error) {
                        console.warn('è®¾ç½®è¡¨æƒ…å¤±è´¥:', error);
                    }
                }
                
                document.getElementById('expression-info').textContent = `è¡¨æƒ…: ${expression}`;
                this.sendMessage('expressionChanged', { expression: expression });
            }
            
            playMotion(motion) {
                this.currentMotion = motion;

                if (!this.model || !this.model.internalModel || !this.model.internalModel.coreModel) {
                    document.getElementById('motion-info').textContent = `åŠ¨ä½œ: æ— æ¨¡å‹`;
                    this.sendMessage('motionPlayed', { motion, ok: false, reason: 'no_model' });
                    return;
                }

                try {
                    const groups = this.getMotionGroups();
                    const requested = String(motion || '').trim();
                    let group = requested;

                    if (!groups.includes(group)) {
                        const idles = ['idle','Idle','IDLE'];
                        const taps = ['tap_body','Tap','TapBody','tap'];
                        if (idles.some(s => groups.includes(s))) group = idles.find(s => groups.includes(s));
                        else if (taps.some(s => groups.includes(s))) group = taps.find(s => groups.includes(s));
                        else if (groups.length > 0) group = groups[0];
                        else {
                            document.getElementById('motion-info').textContent = `åŠ¨ä½œ: æ— å¯ç”¨åŠ¨ä½œ`;
                            this.sendMessage('motionPlayed', { motion: requested, ok: false, groups });
                            return;
                        }
                    }

                    this.model.motion(group);
                    document.getElementById('motion-info').textContent = `åŠ¨ä½œ: ${group}`;
                    this.sendMessage('motionPlayed', { motion: group, ok: true, groups });
                } catch (error) {
                    console.warn('æ’­æ”¾åŠ¨ä½œå¤±è´¥:', error);
                    document.getElementById('motion-info').textContent = `åŠ¨ä½œ: å¤±è´¥(${motion})`;
                    this.sendMessage('motionPlayed', { motion, ok: false, error: error.message });
                }
            }
            
            setParameter(parameter, value) {
                this.parameters[parameter] = value;
                
                if (this.model && this.model.internalModel && this.model.internalModel.coreModel) {
                    // çœŸå®Live2Dæ¨¡å‹
                    try {
                        const paramMap = {
                            'eyeOpen': 'ParamEyeLOpen',
                            'mouthOpen': 'ParamMouthOpenY',
                            'angleX': 'ParamAngleX',
                            'angleY': 'ParamAngleY',
                            'angleZ': 'ParamAngleZ'
                        };
                        
                        const paramId = paramMap[parameter];
                        if (paramId) {
                            this.model.internalModel.coreModel.setParameterValueById(paramId, value);
                        }
                    } catch (error) {
                        console.warn('è®¾ç½®å‚æ•°å¤±è´¥:', error);
                    }
                }
                
                // æ›´æ–°UIæ˜¾ç¤º
                this.updateParameterDisplay();
            }
            
            updateParameterDisplay() {
                document.getElementById('eye-value').textContent = `${(this.parameters.eyeOpen * 100).toFixed(0)}%`;
                document.getElementById('mouth-value').textContent = `${(this.parameters.mouthOpen * 100).toFixed(0)}%`;
                document.getElementById('angle-value').textContent = `${this.parameters.angleZ.toFixed(1)}Â°`;
            }
            
            showError(message) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('canvas').style.display = 'none';
                document.getElementById('info').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                document.getElementById('error-message').textContent = message;
            }
            
            sendMessage(type, data) {
                // é€šè¿‡æ§åˆ¶å°è¾“å‡ºæ¶ˆæ¯ï¼ŒPythonç«¯å¯ä»¥ç›‘å¬
                console.log(JSON.stringify({ type: type, data: data }));
            }

            getMotionGroups() {
                const settings = this.model && this.model.internalModel ? this.model.internalModel.settings : null;
                const motions = settings && settings.motions ? settings.motions : null;
                return motions ? Object.keys(motions) : [];
            }
            
            toggleInfoPanel(force) {
                const infoEl = document.getElementById('info');
                if (!infoEl) return;
                if (typeof force === 'boolean') {
                    this.infoVisible = force;
                } else {
                    this.infoVisible = !this.infoVisible;
                }
                infoEl.style.display = this.infoVisible ? 'block' : 'none';
                const btn = document.getElementById('toggle-info');
                if (btn) btn.textContent = this.infoVisible ? 'éšè—é¢æ¿ [H]' : 'æ˜¾ç¤ºé¢æ¿ [H]';
            }
        }
        
        // åˆå§‹åŒ–é¢„è§ˆå™¨
        window.addEventListener('load', () => {
            window.live2dPreview = new Live2DPreview();
        });
    </script>
</body>
</html>